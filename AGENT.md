# エージェントアーキテクチャ詳細 (Agent Architecture)

本システムは、LangGraphを用いた**自律的修正ループ（Self-Reflective Workflow）**を採用しており、4つの専門エージェントが連携して高度なログ分析を行います。
単方向の分析ではなく、「分析→レビュー→修正」というプロセスを経ることで、幻覚（ハルシネーション）を抑制し、根拠に基づいた信頼性の高いレポートを生成します。

## ワークフロー概要

```mermaid
graph TD
    START --> Context[Context Agent<br>(システム情報官)]
    Context --> Analysis[Analysis Agent<br>(技術探偵)]
    Analysis --> Critic[Critique Agent<br>(厳格なレビュアー)]
    
    Critic -->|REJECT: 証拠不足| Analysis
    Critic -->|APPROVE: 承認| Summary[Summary Agent<br>(プロジェクトマネージャー)]
    
    Summary --> END
```

## 各エージェントの役割

### 1. Context Agent (システム情報官)
*   **役割**: 分析の「前提条件」を定義する。
*   **動作**:
    *   ユーザーがアップロードしたログファイルとは別に、システムの技術スタック（言語、DB、構成）やログフォーマットの定義を会話コンテキストに注入します。
    *   これにより、後続のエージェントが「これはPythonのアプリだ」「このログはPostgreSQLのものだ」と正しく認識できるようになります。

### 2. Analysis Agent (技術探偵)
*   **役割**: ログデータを詳細に調査し、エラー原因を特定する。
*   **動作**:
    *   行番号付きのログデータをスキャンし、エラー、警告、異常なパターンを抽出します。
    *   複数のログファイル（例: アプリログとDBログ）を突き合わせ、因果関係を推論します。
    *   **重要**: 全ての主張に対して、必ず**「ファイル名と行番号」**を引用して証拠を示すことが義務付けられています。

### 3. Critique Agent (厳格なレビュアー)
*   **役割**: Analysis Agentの成果物を品質保証（QA）する。
*   **動作**:
    *   Analysis Agentの分析結果を読み、「主張に対する証拠（ログの引用）が提示されているか？」を厳しくチェックします。
    *   もし証拠が不足していたり、論理が飛躍している場合は、**「REJECT（却下）」**判定を下し、具体的な修正指示を出してAnalysis Agentに差し戻します。
    *   分析が十分であると判断した場合のみ、**「APPROVE（承認）」**判定を下し、次のステップへ進めます。
*   **ループ制御**: 無限ループを防ぐため、最大2回までの差し戻し制限が設けられています。

### 4. Summary Agent (プロジェクトマネージャー)
*   **役割**: 最終的な報告書を作成する。
*   **動作**:
    *   Critique Agentによって承認された技術分析結果をもとに、ビジネスサイド（管理者・開発リーダー）向けのレポートを作成します。
    *   技術的な詳細（スタックトレースなど）を要約し、「何が起きたか」「影響範囲」「推奨アクション」を簡潔にまとめます。

## このアーキテクチャの利点

1.  **信頼性の向上**: 「レビュー」プロセスがあるため、AIが適当なことを言ったり、存在しないエラーを捏造するリスクが大幅に低減します。
2.  **明確な根拠**: 全ての分析結果に行番号が紐付いているため、人間のエンジニアが後でログを確認する際の手間が省けます。
3.  **役割分担**: 「詳細分析」と「要約」を別のエージェントが担当することで、技術的な深さと読みやすさを両立しています。
